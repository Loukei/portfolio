# 整理API操作流程

## About

## 下載檔案

- 下載有三種方法:
  1. 使用[Files: get](https://developers.google.com/drive/api/v3/reference/files/get)取得檔案
  2. 使用[Files: export](https://developers.google.com/drive/api/v3/reference/files/export)取得google doc
  3. 使用file resource 的 `webContentLink`屬性取得連結

## 下載檔案內容(Files: get)

使用下載的客戶必須擁有對檔案的讀取權限才能執行操作，例如`drive.readonly.metadata`scope不允許讀取metadata以外的內容。而即使客戶允許API足夠的權限，若檔案擁有者將`viewersCanCopyContent = false`，任何其他人都無法下載檔案。

如果該檔案被標記為Abusive(濫用、暴力內容)則必須設置`acknowledgeAbuse=true`，必須充分告知使用者其中風險。

### 建立Request

- URL: `GET https://www.googleapis.com/drive/v3/files/fileId?alt=media`
- URL query:
  1. acknowledgeAbuse boolean
  2. fields string
  3. supportsAllDrives boolean

- Body
  - "Authorization" "Bearer [token]"

### Response

If successful, this method returns a [Files resource](https://developers.google.com/drive/api/v3/reference/files#resource) in the response body.

### process flow

``` C++
//! Input:
const QString fileID;
QSaveFile outfile; //ready to write
const QString token;
// optional
bool acknowledgeAbuse = false;
QString fields = "";
bool supportsAllDrives = false;
//! Output:
QSaveFile outfile;
File resource

//! 0. Create writeable open file
QSaveFile* createWriteableOpenedFile(const QString &filepath);
"檢查路徑並建立一個開啟好的檔案，如果失敗回傳nullptr"

//! 1. Build Url
QUrl url = buildUrl(fileID,"alt = media",acknowledgeAbuse,fields,supportsAllDrives);

//! 2. Build request
QNetworkRequest request = buildRequest(url,token);
request.setRawHeader("Authorization",QByteArray("Bearer " + token.toLatin1()));
"將token嵌入Authorization header"

//! 3. send request
QNetworkReply *reply = networkAccessManager()->get(request);

//! 4. handle reply
connect(reply,&QNetworkReply::finished,
        this,&Downloader::on_Download_ReplyFinished);
"如果發生錯誤，關閉並刪除本地檔案。
 如果沒有錯誤，保存reply 輸出並使用deleteLater() 刪除"
connect(reply,QOverload<QNetworkReply::NetworkError>::of(&QNetworkReply::error),
        this,&Downloader::on_Download_ReplyError);
"負責輸出錯誤訊息"
connect(reply,&QNetworkReply::readyRead,
        this,&Downloader::on_Download_readyRead);
"寫入檔案，減少RAM使用"
```

## 上傳檔案

## 更新檔案
